import sys
import os
from rdkit import Chem

# Try to use the function directly instead of HTTP request
try:
    from load_smarts import preprocess_and_expand
    USE_DIRECT = True
except ImportError:
    import requests
    url = "http://localhost:8000/api/v1/load_smarts/preprocess_expand"
    USE_DIRECT = False

# Try to read from example.sma file first
smarts_text = None
example_sma_path = os.path.join(os.path.dirname(__file__), '..', '..', 'example.sma')
if os.path.exists(example_sma_path):
    with open(example_sma_path, 'r') as f:
        smarts_text = f.read()
        # Replace literal \n with actual newlines if needed
        if '\\n' in smarts_text and '\n' not in smarts_text[:100]:
            smarts_text = smarts_text.replace('\\n', '\n')

# Fallback to embedded text if file not found
if not smarts_text:
    smarts_text = """#############################################################################\n### oprea_filters.sma\n###\n### See:\n### http://hatch.health.unm.edu/dbcwiki/index.php/Roadrunner\n###\n#############################################################################\n#\n# Nitro both forms\n#\ndefine $no2A [N;+1](=O)[O;-1]\ndefine $no2B N(=O)=O\ndefine $no2 [$no2A,$no2B]\n#\n# amines\n#\ndefine $spone [S,P]=O\ndefine $cene C=[O,S,C]\ndefine $elneg [$cene,$spone]\ndefine $amine1 [N;D1;H3&+1,H2&+0][C,c;!$elneg]\ndefine $amine2 [N;D2;H2&+1,H&+0]([C,c;!$elneg])[C,c;!$elneg]\ndefine $amine3 [N;D3;H&+1,H0&+0]([C,c;!$elneg])([C,c;!$elneg])[C,c;!$elneg]\n#\n# not carbon\n#\ndefine $notc [!#6]\n#\n#   Al/Ar Amine \n#\ndefine $cnh [$amine1,$amine2,$amine3]\ndefine $cxnh [$notc;!$cnh]~[C,c]\n#\n#   Halogen \n#\ndefine $nothal [!Cl;!Br;!I;!F]\ndefine $anyhal [Cl,Br,I,F]\ndefine $halnotF [Cl,Br,I]\n#\n#   Cyanide \n#\ndefine $cyanide C#N\n#\n#   CH2Hal and CH(Hal)2 and C(Hal)3 \n#\ndefine $ewx1 [C;H2][$anyhal]\ndefine $ewx2 [C;H1]([$anyhal])[$anyhal]\ndefine $ewx3 C([$anyhal])([$anyhal])[$anyhal]\ndefine $ewcl1 [C;X4][$halnotF]\ndefine $ewcl2 [C;X4]([$halnotF])[$halnotF]\ndefine $ewcl3 [C;X4]([$halnotF])([$halnotF])[$halnotF]\n#\n#   SO3C(Hal)3 SO3CH(Hal)2 SO3CH2Hal SO3CH3 \n#\ndefine $smarty1 S(=O)(=O)(O)C([$anyhal])([$anyhal])[$anyhal]\ndefine $smarty2 S(=O)(=O)(O)[C;H1]([$anyhal])[$anyhal]\ndefine $smarty3 S(=O)(=O)(O)[C;H2][$anyhal]\ndefine $smarty4 S(=O)(=O)(O)[C;H3]\n#\n#\n(*).(*) disconnected structures\n#\n#   includes salts, hydrates, racemates \n#\n#   isotopes \n#\ndefine $iso1 [2H]\ndefine $iso2 [3H]\ndefine $iso3 [13C]\ndefine $iso4 [13c]\ndefine $iso5 [14C]\ndefine $iso6 [14c]\ndefine $iso7 [15N]\ndefine $iso8 [15n]\n[$iso1,$iso2,$iso3,$iso4,$iso5,$iso6,$iso7,$iso8] isotopes\n#\n#   unacceptable elements\n#\ndefine $AtmOK [C,c,N,n,O,o,F,Si,P,S,s,Cl,Br,I,#1]\n#\n[A,a;!$AtmOK] AtmCrp\n#\n#   heteroatoms = polar_atoms N, O, P, S\n#\ndefine $polatom [#7,#8,#15,#16]\n#\n### THIS CANNOT BE CORRECT!\n#\t[#6]~[$polatom] cpol\n#\n#   quaternary atoms; excludes sulfoxides \n#\n[+1;#6,F,Cl,Br,I,#8,#16;!$([S+][O-])] poschatom \n#\n#   compounds with >=4 acidic groups \n#\n[C,S,P](=O)[OH].[C,S,P](=O)[OH].[C,S,P](=O)[OH].[C,S,P](=O)[OH] more4acid\n#\n#\n#   hydroxy OH/SH/ethers (bin if <=1 and no other het ie if cor<=1 &&\n#    cxor=0)\n#   what about if any halogens in addition to 1*O/S? \n#\ndefine $acid1 [S,O;H1]C(=[S,O])[C,c] \ndefine $acid2 [S,O;H0;-1]C(=[S,O])[C,c] \ndefine $ester [S,O]([C,c])C(=[S,O])[C,c,N] \ndefine $coh [O,S;X2;H;!$acid1][C,c] \ndefine $cxoh [$notc;!$coh]~[C,c] \ndefine $cor [O,o,S,s;X2;!$ester]([C,c])[C,c] \ndefine $cxor [$notc;!$cor]~[C,c]\n#\n#   2. quaternary (bin if <=1 and no other het ie if cquatern<=1 &&\n#      cxquater=0)\n#   3. or if the only other het is a halogen ie if cquatern<=1 && cxquathl=0 \n#\ndefine $quat1 [+1;N;H0;D3]([C,c])[C,c]\ndefine $quat2 [+1;N;D4]([C,c])[C,c]\ndefine $quat3 [+1;n;D3](c)c\ndefine $quat4 [+1;n;D4](c)c\ndefine $noxide1 [n;X3;+1]([O;X1;-1])(c)c\ndefine $noxide2 [N;X4,X3;+1]([O;X1;-1])([C,c])[C,c]\ndefine $cquatern [$quat1,$quat2,$quat3,$quat4;!$noxide1;!$noxide2]\ndefine $cxquater [$notc;!$cquatern;!$anyhal]~[C,c]\n#\n#   only hetero is 1 COOH or 1 COOR (this def gives count 2 = 1\n#      acid/ester)\n#   bin if cacid<=2 and cxacid=0 \n#\ndefine $acid1a [S,O]=C([S,O;H1])[C,c]\ndefine $acid2a [S,O]=C([S,O;H0;-1])[C,c]\ndefine $estera [S,O]=C([S,O][C,c])[C,c]\ndefine $acidoo [$acid1,$acid2,$acid1a,$acid2a]\ndefine $esteroo [$ester,$estera]\ndefine $cacid [$acidoo,$esteroo]\ndefine $cxacid [$notc;!$cacid]\n#\n#\n#   Garbage, Nitrogen\n#\n#   hydrazine RRN-NRR not in ring, nor diketo, nor keto/edring, nor\n#      diedring \n#\ndefine $hydraz1 [N;X3;R0;!$no2]-[N;X3;!$no2]\ndefine $edring1 cn\ndefine $edring2 ccn\ndefine $edring3 cccn\ndefine $carbonyl C=[O,S]\ndefine $edring [$edring1,$edring2,$edring3]\n#\ndefine $hyzinok [N;X3;R0]([$edring,$carbonyl])-[N;X3][$edring,$carbonyl]\ndefine $hydrazin [$hydraz1;!$hyzinok]\n[$hydrazin] hydrazin\n#\n#   azo N=N or diazoniu N#N\n#   includes N=NN, N=[N;+1]=[N;-1], [N;-1][N;+1]#N, N=[N:+1][O:-1] \n#\ndefine $azodiaz [N;R0]=,#N\n[$azodiaz] azodiaz\n#\n#   carbodiimide \n#\ndefine $carbdiim N=[C;R0]=N\n[$carbdiim] carbdiim\n#\n#   biguanide \n#\ndefine $biguan N(C(=N)N)C(=N)N\n[$biguan] biguan\n#\n#   isocyanide = isonitril -NC \n#\ndefine $isocn1 N=[C;H0;D1]\ndefine $isocn2 [N;+;X2]#[C;-;H0;D1]\ndefine $isocn [$isocn1,$isocn2]\n[$isocn] isocyanide\n#\n# cyanohydrins and acylcyanides \n\ndefine $cyanohydrins N#CC[OH]\ndefine $acylcyanides N#CC=O\n#\n[$cyanohydrins,$acylcyanides] cyanohydrins and acylcyanides \n#\n# nitroso \n#\n[N&D2]=O nitroso\n#\n#  cloramidine \n#\n[Cl]C([C&R0])=N cloramidine \n#\n#  Schiffs base/imine RN=CRR remove them bin if >=1 (hydrolyse to\n#     ketone)\n#  (excluding benzodiazepine - probably too narrow an exclusion)\n#  excluding cyclic imines\n#  excluding ArN=C(Ar) NO - Brian M & Richard S\n#\ndefine $bzdiazep N1=Cc2ccccc2NC(=O)C1\ndefine $imine1 [N;X2;H1]=[C;X3]([C,c])[C,c]\ndefine $imine2 [N;X2;R0]([C,c])=[C;H;X3]([C,c])\ndefine $imine3 [N;X2]([C,c])=[C;H2;X3]\ndefine $imine4 [N;X2;R0]([C,c])=[C;X3]([C,c])[C,c]\ndefine $imine5 [N;X2](c)=[C;X3](c)[C,c]\ndefine $imine6 [N;X2](c)=[C;H;X3](c)\ndefine $imine [$imine1,$imine2,$imine3,$imine4;!$imine5;!$imine6]\n#\n[$imine] imine\n#\n#  hydrazone RRC=N-NRR and not in ring (the C can be aromatic)\n#  hydrazone [N;X2;R0](=[C,c])-[N;X3] (0,$]\n#  azine C=N-N=C and azide NNN and not in ring (see azodiaz) \n#\n[N;X2;R0](=[C;X3])-[N;X2;R0]=[C;X3] azine\n#\n#  nitrite \n#\nN(=O)-O-[C,c] nitrite\n#\n#  isourea \n#\n[N;X3][C;R0]([O;X2])=[N;X2] isourea\n#\n#  beta (mesyl or halo) amine or O/S mustard bin if mustard >=1\n#  hits on trihal (and dihal) may not be nasty but we still get them \n#\ndefine $mustarda [$halnotF][C;X4][C;X4][$cnh]\ndefine $mustards S(=O)(=O)O[C;X4][C;X4][$cnh]\ndefine $mustard [$mustarda,$mustards]\n[$mustard] mustard\n#\n#  CNOC in chain not in ring - hydroxylamine - remove if NH or OH\n#  Hydroxamic acid is OK \n#\ndefine $cnocn1 [N;X3;R0]([C,c])[O;H]\ndefine $cnocn2 [N;X3;R0;H]([C,c])O\ndefine $cnocn3 [N;X3;R0](C=O)O\ndefine $cnocn [$cnocn1,$cnocn2;!$cnocn3]\n[$cnocn] cnocn\n#\n#         Garbage, Halogen\n#\n#  remove if no halogen >=7\n#  more7hal [$anyhal] [7,$]\n#  N-halogen & S-halogen & CH2-halogen \n#\ndefine $nhal N[$anyhal]\n[$nhal]\ndefine $shal S[$anyhal]\n[$shal]\ndefine $phal P[$anyhal]\n[$phal]\ndefine $ohal O[$anyhal]\n[$ohal]\ndefine $ch2hal [CH2][$anyhal]\n[$ch2hal]\n#\n#  acid halide & thio acid halide \n#\ndefine $thachal [S,O]=C[$anyhal]\n[$thachal]\n#\n#  imine halide \n#\ndefine $iminhal [N;R0]=C[$anyhal]\n[$iminhal]\n#\n#  halopyrimidine ; includes purine bases \n#\ndefine $halopyrimidine [$anyhal]c1ncccn1\n[$halopyrimidine]\n#\n#  sulfonyl halide \n#\ndefine $sulfonhal O=S(=O)[$anyhal]\n[$sulfonhal]\n#\n#  1. triflates SO3CX3 \n#\ndefine $trif [$smarty1]\n[$trif]\n#\n#  perhalo ketones \n#\ndefine $haloket [CH2]C(=O)C([$anyhal])([$anyhal])[$anyhal]\n[$haloket] perhalo ketones \n#\n#  halo methylene ether (nasty) cf Isabel's hlmtheth and hletheth &\n#     vinylew\n#  halmeo [$ewcl1,$ewcl2,$ewcl3]OC (0,$]\n#  alpha halo (hal=1,2,3) ketone bin if >=1 \n#\ndefine $halmtha [$ewcl1,$ewcl2,$ewcl3]C=O\ndefine $halmthn [$ewcl1,$ewcl2,$ewcl3]C(=O)N\n#\n#  halmthk [$halmtha;!$halmthn] (0,$]\n#  vinyl and Hal (not nitrile) *** why R0 in Isabel's definitions?\n#\ndefine $vinylew [$halnotF][C;R0]=C\n[$vinylew]\n#\n#  CH2Hal: CBr3, CBr2, CBr, CCl2, CCl; hal-C-C-R is ok - OK if >=2*C \n#\ndefine $alkcl3 [C;X4](Cl)(Cl)Cl\ndefine $alkhal1 [C;X4][$halnotF]\ndefine $alkhal2 [C;X4;H2]([$halnotF])[C;X4]\ndefine $alkhal3 [C;X4;H]([$halnotF])([$halnotF])[C;X4]\ndefine $alkhal4 [C;X4]([$halnotF])([$halnotF])([$halnotF])[C;X4]\ndefine $alkhalok [$alkcl3,$alkhal2,$alkhal3,$alkhal4]\n#\n#  alkhal [$alkhal1;!$alkhalok;!$halmtha;!$halmeo] (0,$]\n#  halo (inc F) triazine or 2-, 4-pyrimidine bin all\n#  do not bin 2-amino, 4-Cl pyrimidine nor 2-amino, 4-Cl triazine \n#\ndefine $halpyr1 [$anyhal]c1ncncc1\ndefine $halpyn2 [$anyhal]c1nc(N)ncc1\ndefine $halpyn3 [$anyhal]c1ncnc(N)c1\ndefine $halpyn4 [$anyhal]c1ncncc1N\ndefine $halpy1 [$halpyr1;!$halpyn2;!$halpyn3;!$halpyn4]\ndefine $halpyr2 [$anyhal]c1ncccn1\ndefine $halpyn5 [$anyhal]c1nc(N)ccn1\ndefine $halpyn6 [$anyhal]c1ncc(N)cn1\ndefine $halpy2 [$halpyr2;!$halpyn5;!$halpyn6]\ndefine $haltriz1 [$anyhal]c1ncncn1\ndefine $haltrn1 [$anyhal]c1nc(N)ncn1\ndefine $haltri1 [$haltriz1;!$haltrn1]\ndefine $haltriaz [$halpy1,$halpy2,$haltri1]\n#\n#         Garbage, Oxygen\n#\nOO peroxides\n#\n#  Aliphatic C-aldehyde RC(=O)H ; aldehyde is stable if it is cCHO or\n#     [N,O,S]CCHO \n#\ndefine $aldnos O=[C;H1]C[N,O,S]\ndefine $aldcx O=[C;H1]C\ndefine $aldehyde [$aldcx;!$aldnos]\n[$aldehyde] aldehyde\n#\n#  anhydride bin if anhydrid>=1 \n#\ndefine $anhydride O=C([C,c])OC(=[O,N])[C,c]\n[$anhydride] anhydride\n#\n#  triacyloximes \n#\ndefine $triacyloxime O=CN(C=O)OC(=O)\n[$triacyloxime] triacyloxime\n#\n#  sugar \n#\ndefine $sugar1 O[C;R0][C;R0](O)[C;R0](O)[C;R0](O)[C;R0]-,=O\ndefine $sugar2 O1C([O;R0])C([O;R0])C([O;R0])C([O;R0])C1([O,C;R0])\ndefine $sugar [$sugar1,$sugar2]\n[$sugar] sugar\n#\n#  sugar OCC(O)C(O)C(O)C-,=O (0,$]\n#  sugoh [O;X2;H;!$acid1][C,c] *\n#  sugor [O;X2;!$ester](C)[C,c] *\n#  sugaro [$sugoh,$sugor] (0,$]\n#\n#  poly (CCO) bin if ccochain>=1 \n#\ndefine $cco2 [C;H2][C;H2][O;D2][C;H2][C;H2][O;X2]\ndefine $ccoring [O;D2;R][C;H2][C;H2][O;D2;R][C;H2][C;H2][O;X2;R][C;H2][C;H2]\ndefine $cco5 [O;D2]([$cco2])[$cco2]\ndefine $ccochain [$ccoring,$cco5]\n[$ccochain] ccochain\n#\n#  quinones\n#  quinones O=C1[#6]~[#6]C(=O)[#6]~[#6]1 (0,$]\n#\n#  benzoquinone \n#\ndefine $bquinon4 [N,O;R0]=[C,c]1[C,c]=,:[C,c][C,c](=[C,N,O;R0])[C,c]=,:[C,c]1\ndefine $bquinon2 [N,O;R0]=[C,c]1[C,c](=[C,N,O;R0])[C,c]=,:[C,c][C,c]=,:[C,c]1\ndefine $bquinone [$bquinon4,$bquinon2]\n[$bquinone] bquinone\n#\n#  2,3,4, & 2,4,5 trihydroxyphenyl \n#\ndefine $triOHph1 c([OH])c([OH])c([OH])\ndefine $triOHph2 c([OH])c([OH])cc([OH])\ndefine $triOHph [$triOHph1,$triOHph2]\n[$triOHph] triOHph\n#\n#         Garbage, Sulfur\n#\n#  SS \n#\ndefine $disulphide [S;$(S[#6,#16]);!$(S(=O))]-[S;$(S[#6,#16]);!$(S(=O))]\n[$disulphide] disulphide\n#\n#  SN \n#\ndefine $SN [S;!$(S(=O));!$(S(=N))]-[N;!$(N=[#6,#7])]\n[$SN] SN\n#\n#  SO \n#\ndefine $SO [S;D1,D2;R0;!$(S(=O))]-[O;D1,D2;R0]\n[$SO] SO\n#\n#  sulfonyl cyanides \n#\ndefine $scn O=S(=O)C#N\n[$scn] sulfonyl cyanides \n#\n#  sulphonamide imine (Michael) but not sulphonamide amidine nor in ring \n#\ndefine $so2nc1 [S;X4](=O)(=O)N=C\ndefine $so2nc2 [S;X4](=O)(=O)N=CN\ndefine $so2ncr5 [S;X4]1(=O)(=O)N=C[C,c]~[C,c]1\ndefine $so2ncr6 [S;X4]1(=O)(=O)N=C[C,c]~[C,c]~[C,c,N,n]1\ndefine $so2nc [$so2nc1;!$so2nc2;!$so2ncr5;!$so2ncr6]\n[$so2nc] so2nc\n#\n#  isocyanates & isothiocyanates \n#\ndefine $isothcn [S,O]=C=N\n[$isothcn] isothcn\n#\n#  thiocyanate \n#\ndefine $thcn SC#N\n[$thcn] thiocyanate \n#\n#         Garbage, P(III)\n#\n#  phosphorous acid/ester \n#\ndefine $pphorous [P;X3]([O;X2])([O;X2])[O;X2]\ndefine $pphonous [P;X3]([O;X2])([O;X2])[C,c]\ndefine $pphinous [P;X3]([O;X2])([C,c])[C,c]\ndefine $pphine [P;X3]([C,c])([C,c])[C,c]\ndefine $phos3 [$pphorous,$pphonous,$pphinous,$pphine]\n[$phos3] phosphorous acid/ester \n#\n#         Garbage, P(V)\n#\n#  phosphoric acid/ester \n#\ndefine $pphoric [P;X4](=O)([O;X2])([O;X2])[O;X2]\ndefine $pphonic [P;X4](=O)([O;X2])([O;X2])[C,c]\ndefine $pphinic [P;X4](=O)([O;X2])([C,c])[C,c]\ndefine $pphino [P;X4](=O)([C,c])([C,c])[C,c]\ndefine $pphane [P;X5]([C,c])([C,c])([C,c])([C,c])[C,c]\ndefine $pphonim [P;X4](=O)([O;X2])([N;X3])[C,c]\ndefine $pphnylid [P;X4](=C)([C,c])([C,c])[C,c]\ndefine $phos5 [$pphoric,$pphonic,$pphinic,$pphino,$pphane,$pphonim,$pphnylid]\n[$phos5] phosphoric acid/ester \n#\n#  Lawesson's reagent and derivatives \n#\nS=P(S)S Lawesson's reagent and derivatives \n#\n#  phosphoramides \n#\nNP(=O)(N)N phosphoramides \n#\n#  Disubs phosphine oxide R2P=O \n#\n[P;D3](=O)([!O])[!O] Disubs phosphine oxide R2P=O \n#\n#  phosphonium cation \n#\n[P&+1;D4]([!O])([!O])([!O])[!O] phosphonium cation \n#\n#  PS or phosphonium ylide or phosphonium imide \n#\ndefine $pgrot1 P~S\ndefine $pgrot2 P=[N,C]\ndefine $pgrot [$pgrot1,$pgrot2]\n[$pgrot] PS or phosphonium ylide or phosphonium imide \n#\n#  cyanophosphonates \n#\nP(OOC)(OOC)(=O)C#N cyanophosphonates \n#\n#         Garbage, Unsaturated\n#\n#  alpha unsat ketones C=C-C=O Michael acceptors bin if michael>=1\n#  if c-C=C-C=O it is possibly stable enough \n#\ndefine $acidlg1 C(=O)[O&H,O&-1]\ndefine $acidlg2 C(=O)[O,S][C,c,N]\ndefine $keto C(=O)([C,c])C\ndefine $ald [C;H](=O)\ndefine $amid C(=O)([N;X3])\ndefine $sone S(=O)(=O)([C,c])[C,O]\ndefine $side S(=O)(=O)([N;X3])\ndefine $michlg1 [$keto,$ald,$amid,$sone,$side,$no2,$acidlg1,$acidlg2]\ndefine $michlg [$keto,$ald,$amid,$sone,$side,$no2,$acidlg1,$acidlg2,$cyanide]\ndefine $michlg2 [$halnotF,$cyanide]\ndefine $michneda [C;H2]\ndefine $michnedb [C;H][!N;!$cor;!$coh;!c]\ndefine $michnedc C([!N;!$cor;!$coh;!c])[!N;!$cor;!$coh;!c]\ndefine $michned [$michneda,$michnedb,$michnedc]\ndefine $michael1 [$michlg]C=[$michned]\n[$michael1]\n#\ndefine $mich1 [$michlg]C=[$michned]\ndefine $mich2 [$michlg]C=C[$michlg]\ndefine $mich3 [$michlg]C([$michlg])=C\ndefine $michael2 [$mich1,$mich2,$mich3]\n[$michael2]\n#\n#  acetylene 1-,2-cruds \n#\ndefine $michael3 [$michlg]C#C\n[$michael3]\n#\n#  reactive beta keto quaternary O=CCN+ \n#\ndefine $ketoquat [$cquatern]CC=O\n[$ketoquat] reactive beta keto quaternary O=CCN+ \n#\n#  reactive esters and thioesters RCOOCX2 X=Hal/CN/Ph ?? \n#\ndefine $reactx1 [$halnotF,$cyanide]\ndefine $reactx2 [$anyhal,$cyanide]\ndefine $reactx3 [$anyhal,$cyanide,c]\ndefine $reactst1 O=C[O,S]C[$reactx1]\ndefine $reactst2 O=C[O,S]C([$reactx2])[$reactx2]\ndefine $reactst3 O=C[O,S]C([$reactx3])([$reactx3])[$reactx3]\ndefine $reactst4 O=C(C([$reactx2])[$reactx3])[O,S][C,c]\ndefine $reactst5 O=[C;X3][O,S]c\ndefine $reactst6a O=[C;X3][O,S]C=C\ndefine $reactst6b O=[C;X3]1[O,S]C=CC1\ndefine $reactst6c O=[C;X3]1[O,S]C=CCC1\ndefine $carbamat O=C([O,S])N\ndefine $reactst6 [$reactst6a;!$reactst6b;!$reactst6c]\ndefine $reactest1 [$reactst1,$reactst2,$reactst3,$reactst4,$reactst5,$reactst6]\n#\ndefine $reactest [$reactest1;!$carbamat]\n[$reactest]\n#\n#         LARGE RINGS, LARGE ALKYL CHAINS\n#\n#  Large ring >=C9 (bin if c9str>=1 or c9rng>=1) \n#\ndefine $c9rng1 [r9,r10,r11,r12,r13,r14;C]\ndefine $c9rng [$c9rng1][C;x2][C;x2][C;x2][C;x2][C;x2][C;x2][C;x2][C;x2]\n[$c9rng] LARGE RINGS, LARGE ALKYL CHAINS\n#\n#  crown ethers \n#\ndefine $crownether [O;x2][C;x2][C;x2][O;x2][C;x2][C;x2][O;x2]\n[$crownether] crownether\n#\n#  1. C9 chain Not in any rings = max flex chain 1 descriptor in saSA \n#\ndefine $c9str [C;R0][C;R0][C;R0][C;R0][C;R0][C;R0][C;R0][C;R0][C;R0]\n[$c9str] c9str\n#\n#  straight chain or Al ring no branching (bin if branch=0)\n#  straight [A;D2,D1] *\n#  branch [!$straight] (0,$]\n#  branch [A;D3,D4] (0,$]\n#  multi alkene chain CC=CC=CC=C \n#\ndefine $mltalken [C;X3;!R]=C[C;!R]=C[C;!R]=[C;X3]\n[$mltalken]\n#\n#         Ugly Structures\n#  annelated rings pyrene, phenanthrene, anthracene, adamantane (bin\n#     if >=1) \n#\ndefine $pyrene c1cc2ccc3cccc4ccc(c1)c2c34\ndefine $phenan c12ccccc1ccc3ccccc32\ndefine $anthrac c1c2ccccc2cc3ccccc31\ndefine $big3 c12c3~[N,C,c]~[N,C,c]~[N,C,c]~c1aaaa2aaa3\ndefine $adamant C12CC3CC(C1)CC(C2)C3\ndefine $bigring [$pyrene,$phenan,$anthrac,$big3,$adamant]\n[$bigring]\n#\n#  diazetidinone ring \n#\nN1C(=O)NC(=O)1 diazetidinone ring \n#\n#  cycloheximide derivatives \n#\nO=C1CCCC(N1)=O cycloheximide derivatives \n#\n#  epoxides & aziridines & thiiranes & oxazirane \n#\ndefine $epazthi C1[N,O,S]C1\ndefine $oxaz N1[S,O]C1\n[$epazthi,$oxaz] epoxides & aziridines & thiiranes & oxazirane \n#\n#  4 membered lactones \n#\ndefine $lactone4 O=C1OCC1\n[$lactone4] 4 membered lactones \n#\n#         Unsuitable Substructures\n#\n#  diphenyl ethylene cyclohexadiene \n#\ndefine $dyecore1 C1=CCC=CC1=C(c2ccccc2)c3ccccc3\ndefine $dyecore2 C1=CCC=CC1=C(c2ccccc2)C\ndefine $dyecore [$dyecore1,$dyecore2]\n[$dyecore]\n#\n#  p-, p'-dihydroxy biphenyl, stilbene \n#\ndefine $diohbiph [O;H]c1ccc(cc1)c2ccc([O;H])cc2\n[$diohbiph]\ndefine $diohstil [O;H]c1ccc(cc1)[C;R0]=[C;R0]c2ccc([O;H])cc2\n[$diohstil]\n#\n#  saponin derivatives \n#\ndefine $saponin O1CCCCC1OC2CCC3CCCCC3C2\n[$saponin]\n#\n#  cytochalasin derivatives \n#\ndefine $cytochalasin O=C1NCC2CCCCC21\n[$cytochalasin]\n#\n#  betalactams \n#\ndefine $blactams O=C1CCN1\n[$blactams]\n#\n#  monesin derivatives \n#\ndefine $monesin O1CCCCC1C2CCCO2\n[$monesin]\n#\n#  squalestatin derivatives \n#\ndefine $squalestatin C12Occc(O1)CC2\n[$squalestatin]\n#\n#  steroid \n#\ndefine $steroid1 [C,c]12~[C,c]~[C,c]~[C,c]~[C,c]~[C,c]~1~C(~C3~C~C~2)~C~C~C4CCCC~4~3\ndefine $steroid2 [C,c]12~[C,c]~[C,c]~[C,c]~[C,c]~[C,c]~1~C(~C3~C~C~2)~C~C~C4CCCCC~4~3\ndefine $steroid [$steroid1,$steroid2]\n[$steroid] steroid\n#\n#  penicillin or cephalosporin \n#\ndefine $penicil N12C(=O)CC1SC~C2\ndefine $carpenem N12C(=O)CC1CC~C2\ndefine $cephalo N12C(=O)CC1SC~C~C2\ndefine $penceph [$penicil,$carpenem,$cephalo]\n[$penceph] penicillin or cephalosporin \n#\n#  prostaglandin \n#\ndefine $prostag C1CCC([C;R0]~C~C~C~C~C)C1[C;R0]~C~C~C\n[$prostag] prostaglandin \n\n"""

def validate_smarts(expanded_lines):
    """
    Validate expanded SMARTS using RDKit.
    Each line must be: "<SMARTS> <name>"
    """
    valid = []
    invalid = []

    for line in expanded_lines:
        parts = line.split(maxsplit=1)
        smarts = parts[0]
        name = parts[1] if len(parts) > 1 else "unknown"

        mol = Chem.MolFromSmarts(smarts)
        if mol is None:
            invalid.append((smarts, name))
        else:
            valid.append((smarts, name))

    return valid, invalid


try:
    if USE_DIRECT:
        print("Using direct function call...")
        expanded = preprocess_and_expand(smarts_text)
    else:
        print("Using HTTP request to server...")
        response = requests.post(
            url,
            json={"smarts_text": smarts_text},
            timeout=60
        )

        print("Status code:", response.status_code)
        print("Content type:", response.headers.get("Content-Type"))

        result = response.json()
        expanded = result.get("expanded_smarts", [])

    print("Total expanded SMARTS:", len(expanded))

    # ---------- RDKit validation ----------
    valid, invalid = validate_smarts(expanded)

    print("Valid SMARTS:", len(valid))
    print("Invalid SMARTS:", len(invalid))

    if invalid:
        print("\nFirst 10 invalid SMARTS:")
        for smarts, name in invalid[:10]:
            print(f"{smarts} {name}")

except Exception as e:
    if USE_DIRECT:
        print(f"Error: {e}")
        import traceback
        traceback.print_exc()
    else:
        if isinstance(e, requests.exceptions.JSONDecodeError):
            print("Server did not return valid JSON")
            print(response.text[:1000])
        elif isinstance(e, requests.exceptions.RequestException):
            print("Request failed:", e)
        else:
            print(f"Error: {e}")
            import traceback
            traceback.print_exc()
